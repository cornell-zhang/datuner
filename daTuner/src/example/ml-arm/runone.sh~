#!/bin/bash

if [ "$#" -ne 6 ]; then
  echo "Usage: <tech><design><type multiCPU|thread><procnum><test-limit><nomsg|msg>"
  exit
fi

tech=$1
design=$2
plat=$3
num=$4
testLimit=$5
msg=$6
machine="03"

if [ $plat == "thread" ];then
  msg="nomsg"
fi
exptype=$plat-$num-$msg

mkdir experiment
mkdir experiment/$exptype
mkdir experiment/$exptype/$tech
mkdir experiment/$exptype/$tech/$design

cp ./hostfile ./adddeps.py ./runTuner.py ./tuneVPR.py  ./experiment/$exptype/$tech/$design
sed -e "s/DESIGN_HOLDER/$design/g" -e "s/EXPTYPE_HOLDER/$exptype/g" -e "s/TECH_HOLDER/$tech/g" ./tuneVPR.py  >  ./experiment/$exptype/$tech/$design/tuneVPR.py
sed -e "s/MSG_HOLDER/$msg/g"  ./runTuner.py > ./experiment/$exptype/$tech/$design/runTuner.py

runhost="--hostfile hostfile"
if [ $plat == "thread" ];then
  runhost="--host zhang-${machine}.ece.cornell.edu"
fi
parallelism=1
if [ $plat == "thread" ]&&[ $num != "1" ];then
  parallelism=$num
  num=1
fi

cd experiment/$exptype/$tech/$design  
mpirun $runhost -n $num python runTuner.py  --technique=$tech --parallelism $parallelism --test-limit $testLimit |&tee log 2>&1 

cd ../../../../


